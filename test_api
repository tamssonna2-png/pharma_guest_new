#!/usr/bin/env python3

import google.generativeai as genai
import base64
import mimetypes


import googleapiclient.discovery

def get_video_comments(video_id, api_key):
    """
    R√©cup√®re les commentaires de niveau sup√©rieur d'une vid√©o YouTube.

    Args:
        video_id (str): L'ID de la vid√©o YouTube.
        api_key (str): Votre cl√© API YouTube Data API v3.

    Returns:
        list: Une liste de dictionnaires, o√π chaque dictionnaire repr√©sente un commentaire
              avec l'auteur et le texte du commentaire.
              Retourne une liste vide si aucun commentaire n'est trouv√© ou en cas d'erreur.
    """
    try:
        # Initialisation du client API
        youtube = googleapiclient.discovery.build(
            "youtube", "v3", developerKey=api_key
        )

        comments_data = []
        next_page_token = None

        while True:
            # Requ√™te pour les threads de commentaires (commentaires de niveau sup√©rieur)
            request = youtube.commentThreads().list(
                part="snippet",
                videoId=video_id,
                textFormat="plainText",
                maxResults=100,  # Vous pouvez ajuster le nombre de r√©sultats par page (max 100)
                pageToken=next_page_token
            )
            response = request.execute()

            for item in response["items"]:
                comment_snippet = item["snippet"]["topLevelComment"]["snippet"]
                author = comment_snippet["authorDisplayName"]
                comment_text = comment_snippet["textDisplay"]
                comments_data.append({"author": author, "comment": comment_text})

            next_page_token = response.get("nextPageToken")

            if not next_page_token:
                break  # Plus de pages de commentaires

        return comments_data

    except googleapiclient.errors.HttpError as e:
        print(f"Une erreur HTTP s'est produite : {e}")
        # G√©rer les erreurs sp√©cifiques comme les vid√©os sans commentaires ou les quotas d√©pass√©s
        if e.resp.status == 403:
            print("V√©rifiez que l'API est activ√©e et que votre cl√© est correcte.")
        elif e.resp.status == 404:
            print("Vid√©o introuvable ou les commentaires sont d√©sactiv√©s pour cette vid√©o.")
        return []
    except Exception as e:
        print(f"Une erreur inattendue s'est produite : {e}")
        return []



# ‚ö†Ô∏è METTEZ VOTRE CL√â API ICI
API_KEY = "AIzaSyDOQXRcsHhst_E04U0bp4qX31XTLUcHg8g" # c'est pour l'utilisation de l'IA gemeni
API_KEY = "AIzaSyDMe-6wbL_WDDfODkfgsxb_FN8q4Rg-Rmo"
def test_text_generation(comment):
    """Tester la g√©n√©ration de texte"""
    genai.configure(api_key=API_KEY)
    
    model = genai.GenerativeModel('models/gemini-2.0-flash')
    
    texte_comments="\n".join([f"- {c['comment']}" for c in comment[:100]])
    prompt= f"""
    Analyse ces commentaires YouTube et donne-moi un r√©sum√©:
    
    {texte_comments}
    
    R√©sume les th√®mes principaux et le sentiment g√©n√©ral.
    """
    response = model.generate_content(prompt)
    
    print("‚úÖ G√©n√©ration texte r√©ussie!")
    print("R√©ponse:", response.text)

if __name__ == "__main__":

    YOUR_API_KEY = "AIzaSyAbcvU9LPjs45-GyDbqZMjD-N5DVYcSHww"  # Remplacez par votre cl√© API # c'est pour avoir les commentaires des videos youtubes
    VIDEO_ID = "mK3P-ok-vB4"            # Remplacez par l'ID de la vid√©o

    if YOUR_API_KEY == "YOUR_YOUTUBE_API_KEY" or VIDEO_ID == "YOUR_VIDEO_ID":
        print("Veuillez remplacer 'YOUR_YOUTUBE_API_KEY' et 'YOUR_VIDEO_ID' par vos propres valeurs.")
    else:
        print(f"R√©cup√©ration des commentaires pour la vid√©o : {VIDEO_ID}")
        comments = get_video_comments(VIDEO_ID, YOUR_API_KEY)

    print("üéØ Votre compte a acc√®s aux mod√®les r√©cents!")
    
    # Test texte d'abord
    test_text_generation(comments)
    

    #/home/tamekem/myglobalenv/bin/python /home/tamekem/Bureau/school/programmes/NIVEAU_3/INF331/test_api  la commande pour executer ce code sur ubuntu
    #se rassurer d'etre dans un evironement virtuel :source ~/myglobalenv/bin/activate

